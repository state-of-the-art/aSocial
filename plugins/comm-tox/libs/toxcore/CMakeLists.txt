cmake_minimum_required(VERSION 3.16)

project(toxcore)

include(${CMAKE_CURRENT_SOURCE_DIR}/../../../../common.cmake)
include(${CMAKE_CURRENT_SOURCE_DIR}/../../../libs.cmake)

if(ANDROID)
  set(android_params
    -D ANDROID_ABI=${ANDROID_ABI}
    -D ANDROID_PLATFORM=${ANDROID_PLATFORM}
    -D ANDROID_NATIVE_API_LEVEL=${ANDROID_NATIVE_API_LEVEL}
  )
endif()

include(ExternalProject)
ExternalProject_Add(lib_${PROJECT_NAME}
  DEPENDS          lib_sodium
  URL              ${lib_${PROJECT_NAME}_url}
  URL_HASH         ${lib_${PROJECT_NAME}_hash}
  PREFIX           "${CMAKE_BINARY_DIR}/_build"
  INSTALL_DIR      "${LIBS_RESULT_DIR}"
  BUILD_ALWAYS     YES
  CMAKE_COMMAND    ${CMAKE_COMMAND} -E env "PKG_CONFIG_PATH=$ENV{PKG_CONFIG_PATH}:${LIBS_RESULT_DIR}/lib/pkgconfig" ${CMAKE_COMMAND}
  BUILD_BYPRODUCTS  <INSTALL_DIR>/lib/libtoxcore.a
  CMAKE_ARGS
    -D BUILD_TOXAV=OFF
    -D BOOTSTRAP_DAEMON=OFF
    -D DHT_BOOTSTRAP=OFF
    -D ENABLE_SHARED=OFF

    -D CMAKE_INSTALL_PREFIX=<INSTALL_DIR>
    -D CMAKE_FIND_ROOT_PATH=${CMAKE_FIND_ROOT_PATH}
    -D CMAKE_PREFIX_PATH=${CMAKE_PREFIX_PATH}
    -D CMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
    -D CMAKE_TOOLCHAIN_FILE=${CMAKE_TOOLCHAIN_FILE}
    -D CMAKE_FIND_ROOT_PATH_MODE_PROGRAM=${CMAKE_FIND_ROOT_PATH_MODE_PROGRAM}
    -D CMAKE_FIND_ROOT_PATH_MODE_LIBRARY=${CMAKE_FIND_ROOT_PATH_MODE_LIBRARY}
    -D CMAKE_FIND_ROOT_PATH_MODE_INCLUDE=${CMAKE_FIND_ROOT_PATH_MODE_INCLUDE}
    -D CMAKE_FIND_ROOT_PATH_MODE_PACKAGE=${CMAKE_FIND_ROOT_PATH_MODE_PACKAGE}

    ${android_params}
)
